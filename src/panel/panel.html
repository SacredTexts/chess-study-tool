<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess Study Tool</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      width: 100%;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #0f0f1a 0%, #1a1a2e 100%);
      color: #e0e0e0;
      font-size: 14px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* ============ HEADER ============ */
    .header {
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
      cursor: pointer;
      transition: background 0.3s;
      flex-shrink: 0;
    }

    .header-status-dot.loading {
      background: #3498db;
      animation: pulse 1.5s infinite;
    }

    .header-status-dot.success {
      background: #2ecc71;
    }

    .header-status-dot.error {
      background: #e74c3c;
    }

    .header-shortcut {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 10px;
      color: #888;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
    }

    .header-badge {
      font-size: 10px;
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .settings-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .settings-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .header-buttons {
      display: flex;
      gap: 8px;
    }

    .close-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: rgba(231, 76, 60, 0.6);
    }

    /* ============ MAIN CONTENT ============ */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* ============ HEADER CAPTURE BUTTON ============ */
    .header-capture-btn {
      padding: 6px 14px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .header-capture-btn:hover {
      box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
    }

    .header-capture-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .header-capture-btn .spinner {
      display: none;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .header-capture-btn.loading .spinner {
      display: block;
    }

    .header-capture-btn.loading .btn-text {
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Header side toggle (compact) */
    /* ============ STATUS POPOVER ============ */
    .status-popover {
      position: absolute;
      top: 56px;
      left: 12px;
      right: 12px;
      z-index: 100;
      background: #1a1a2e;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .popover-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .popover-thumbnail .thumbnail-container {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    .popover-thumbnail .thumbnail-container img {
      max-width: 100%;
      max-height: 120px;
      border-radius: 4px;
      object-fit: contain;
    }

    .popover-position .fen-display {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.3);
      padding: 6px 8px;
      border-radius: 6px;
      word-break: break-all;
      color: #aaa;
    }

    .popover-position .section-title {
      font-size: 10px;
      margin-bottom: 6px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.loading { background: #3498db; animation: pulse 1.5s infinite; }
    .status-dot.success { background: #2ecc71; }
    .status-dot.error { background: #e74c3c; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .status-text {
      flex: 1;
      font-size: 13px;
      color: #888;
    }

    /* ============ POSITION INFO ============ */
    .section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
      margin-bottom: 10px;
    }

    .fen-display {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0, 0, 0, 0.3);
      padding: 8px 10px;
      border-radius: 6px;
      word-break: break-all;
      color: #aaa;
    }


    /* ============ BEST MOVE ============ */
    .moves-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .best-move-container {
      padding: 4px 10px;
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.15) 0%, rgba(46, 204, 113, 0.05) 100%);
      border: 2px solid rgba(46, 204, 113, 0.4);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .best-move-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .best-move-piece {
      font-size: 18px;
      line-height: 1;
    }

    .best-move-piece.white-piece {
      color: #fff;
      text-shadow: 0 0 3px #000, 1px 1px 2px #000;
    }

    .best-move-piece.black-piece {
      color: #333;
      text-shadow: 0 0 1px #fff;
    }

    .best-move-notation {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .best-move-from {
      color: #888;
    }

    .best-move-arrow {
      font-size: 14px;
      color: #2ecc71;
    }

    .best-move-to {
      color: #fff;
    }

    .best-move-name {
      font-size: 11px;
      color: #888;
      margin-left: auto;
    }

    /* ============ GAME OVER ============ */
    .game-over {
      text-align: center;
      font-weight: 800;
      font-size: 22px;
      padding: 12px 8px;
      border-radius: 10px;
      letter-spacing: 1px;
    }

    .game-over.victory {
      color: #4ade80;
      background: rgba(74, 222, 128, 0.1);
      border: 2px solid #22c55e;
    }

    .game-over.defeat {
      color: #f87171;
      background: rgba(248, 113, 113, 0.1);
      border: 2px solid #ef4444;
    }

    .engine-note {
      padding: 4px 10px;
      border: 2px solid #65a30d;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .engine-note.engine-match {
      border-color: #d97706;
      background: rgba(217, 119, 6, 0.1);
      color: #fbbf24;
    }

    .engine-note.engine-differ {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.08);
      color: #86efac;
    }

    .risk-icon {
      color: #f59e0b;
      font-size: 13px;
    }

    .safe-icon {
      color: #22c55e;
      font-size: 13px;
    }

    /* ============ TOP ENGINE LINES ============ */
    .engine-lines {
      margin-top: 6px;
    }

    .engine-lines-title {
      font-size: 9px;
      color: #556;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .engine-lines-row {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .engine-line-chip {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 6px;
      min-width: 56px;
      cursor: default;
    }

    .engine-line-chip:first-child {
      background: rgba(59, 130, 246, 0.18);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .chip-move {
      display: flex;
      align-items: center;
      gap: 2px;
      font-size: 11px;
      font-weight: 600;
      color: #d0d8e8;
    }

    .chip-piece {
      font-size: 13px;
      line-height: 1;
    }

    .chip-arrow {
      color: #60a5fa;
      font-size: 10px;
    }

    .chip-eval {
      font-size: 9px;
      color: #7aa2d4;
      font-family: monospace;
      margin-top: 1px;
    }

    /* ============ SESSION TRACKER ============ */
    .session-tracker {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .tracker-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .tracker-stats {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }

    .tracker-label {
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .tracker-accuracy {
      font-weight: 700;
      font-size: 13px;
      color: #86efac;
    }

    .tracker-accuracy.warning {
      color: #fbbf24;
    }

    .tracker-accuracy.danger {
      color: #f87171;
    }

    .tracker-detail {
      color: #555;
      font-size: 10px;
    }

    .tracker-bar-wrapper {
      position: relative;
      height: 3px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 2px;
      overflow: visible;
    }

    .tracker-bar {
      height: 100%;
      border-radius: 2px;
      background: #22c55e;
      transition: width 0.3s, background 0.3s;
    }

    .tracker-bar.warning {
      background: #f59e0b;
    }

    .tracker-bar.danger {
      background: #ef4444;
    }

    .tracker-threshold {
      position: absolute;
      top: -2px;
      width: 1px;
      height: 7px;
      background: rgba(255, 255, 255, 0.3);
    }

    .tracker-reset {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.08);
      color: #666;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .tracker-reset:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #aaa;
    }

    /* ============ MINI BOARD ============ */
    .mini-board-container {
      display: flex;
      justify-content: center;
      padding: 8px 0;
    }

    .mini-board-wrapper {
      position: relative;
      width: 160px;
      height: 160px;
    }

    .mini-board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      width: 160px;
      height: 160px;
      border: 1px solid #555;
      border-radius: 4px;
      overflow: hidden;
      font-size: 14px;
    }

    .mini-square {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .mini-square.light {
      background: #f0d9b5;
    }

    .mini-square.dark {
      background: #b58863;
    }

    .mini-square.from-square {
      background: rgba(255, 255, 100, 0.6) !important;
    }

    .mini-square.to-square {
      background: rgba(100, 255, 100, 0.6) !important;
    }

    .mini-square .mini-piece {
      font-size: 16px;
      user-select: none;
    }

    .mini-square .mini-piece.white {
      color: #fff;
      text-shadow: 0 0 2px #000, 1px 1px 1px #000;
    }

    .mini-square .mini-piece.black {
      color: #000;
    }

    /* Arrow overlay */
    .move-arrow-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .move-arrow {
      fill: none;
      stroke: rgba(0, 150, 0, 0.85);
      stroke-width: 6;
      stroke-linecap: round;
      marker-end: url(#arrowhead);
    }

    .placeholder {
      text-align: center;
      color: #555;
      padding: 20px;
      font-style: italic;
    }

    /* ============ CHESS BOARD ============ */
    .chess-board-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .chess-board {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      width: 280px;
      height: 280px;
      border: 2px solid #555;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .chess-square {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: default;
      position: relative;
    }

    .chess-square.light {
      background: #f0d9b5;
    }

    .chess-square.dark {
      background: #b58863;
    }

    .chess-square.highlight {
      box-shadow: inset 0 0 0 3px #ffeb3b;
    }

    .chess-square .piece {
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      user-select: none;
    }

    .chess-square .piece.white {
      color: #fff;
      text-shadow: 0 0 3px #000, 1px 1px 2px #000;
    }

    .chess-square .piece.black {
      color: #000;
    }

    .board-labels {
      display: flex;
      justify-content: space-around;
      width: 280px;
      font-size: 11px;
      color: #888;
      padding: 0 4px;
    }

    .board-labels.files {
      margin-top: 4px;
    }

    .board-ranks {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      height: 280px;
      font-size: 11px;
      color: #888;
      padding: 4px 0;
    }

    .board-wrapper {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Best move highlight */
    .chess-square.best-from {
      box-shadow: inset 0 0 0 3px #4CAF50;
    }

    .chess-square.best-to {
      box-shadow: inset 0 0 0 3px #4CAF50;
      background: rgba(76, 175, 80, 0.3);
    }

    .chess-square.best-to::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: #4CAF50;
      border-radius: 50%;
      opacity: 0.6;
    }

    /* Side toggle switch */
    .side-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .side-label-prefix {
      font-size: 11px;
      color: #888;
      font-weight: 500;
    }

    .toggle-switch {
      position: relative;
      width: 36px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to right, #f0d9b5, #b58863);
      border-radius: 20px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .toggle-switch input:checked + .toggle-slider {
      background: linear-gradient(to right, #b58863, #3a3a3a);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(16px);
      background: #333;
    }

    .move-legend {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 11px;
      color: #888;
      margin-top: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    .legend-dot.from {
      border: 2px solid #4CAF50;
      background: transparent;
    }

    .legend-dot.to {
      background: rgba(76, 175, 80, 0.5);
      border: 2px solid #4CAF50;
    }

    /* ============ SETTINGS PANEL ============ */
    .settings-panel {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .settings-panel.active {
      display: block;
    }

    .main-content.hidden {
      display: none;
    }

    .back-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #ddd;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
    }

    .form-hint {
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }

    /* ============ API KEY WRAPPER ============ */
    .api-key-wrapper {
      display: flex;
      gap: 8px;
    }

    .api-key-wrapper input {
      flex: 1;
    }

    .toggle-key-btn {
      width: 44px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #888;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .toggle-key-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
    }

    .eye-icon {
      width: 18px;
      height: 18px;
    }

    .toggle-key-btn .eye-closed {
      display: none;
    }

    .toggle-key-btn.showing .eye-open {
      display: none;
    }

    .toggle-key-btn.showing .eye-closed {
      display: block;
    }

    .save-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
    }

    .save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    /* ============ STATUS INDICATORS ============ */
    .status-indicators {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-bottom: 12px;
    }

    .status-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .status-indicator:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .status-svg {
      width: 16px;
      height: 16px;
    }

    .status-svg circle {
      transition: fill 0.3s;
    }

    .status-indicator.connected .status-svg circle {
      fill: #2ecc71;
    }

    .status-indicator.disconnected .status-svg circle {
      fill: #e74c3c;
    }

    .status-indicator.checking .status-svg circle {
      fill: #f39c12;
      animation: pulse-indicator 1s infinite;
    }

    .status-indicator.has-errors .status-svg circle {
      fill: #ff69b4;
    }

    @keyframes pulse-indicator {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .status-label {
      font-size: 11px;
      color: #888;
    }

    .error-count {
      font-size: 10px;
      background: #ff69b4;
      color: #fff;
      padding: 1px 5px;
      border-radius: 8px;
      font-weight: 600;
    }

    .check-btn {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .check-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .check-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error-log {
      margin-top: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      overflow: hidden;
    }

    .error-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 105, 180, 0.2);
      font-size: 12px;
      font-weight: 600;
      color: #ff69b4;
    }

    .clear-errors-btn {
      background: transparent;
      border: 1px solid rgba(255, 105, 180, 0.5);
      color: #ff69b4;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
    }

    .clear-errors-btn:hover {
      background: rgba(255, 105, 180, 0.2);
    }

    .error-log-content {
      max-height: 150px;
      overflow-y: auto;
      padding: 8px 12px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #ccc;
    }

    .error-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .error-entry:last-child {
      border-bottom: none;
    }

    .error-time {
      color: #666;
      margin-right: 8px;
    }

    /* ============ API COST DISPLAY ============ */
    .cost-display {
      padding: 8px 12px;
      margin-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .cost-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 2px 0;
    }

    .cost-label {
      font-size: 11px;
      color: #888;
    }

    .cost-value {
      font-size: 11px;
      color: #aaa;
      font-family: monospace;
    }

    /* ============ SETTINGS FOOTER ============ */
    .settings-footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    .settings-version {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }

    .settings-credits {
      display: block;
      font-size: 10px;
      color: #555;
    }


    /* ============ PROVIDER SECTION ============ */
    .provider-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .provider-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .provider-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
    }

    .provider-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .provider-radio-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      padding: 4px 0;
    }

    .provider-radio {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #3498db;
      margin: 0;
    }

    .provider-radio:checked + .provider-title {
      color: #3498db;
      font-weight: 600;
    }

    .provider-section.is-active {
      border-color: rgba(52, 152, 219, 0.4);
    }

    /* ============ SCROLLBAR ============ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <button class="header-capture-btn" id="capture-btn">
      <span class="btn-text">&#128248; Capture</span>
      <span class="spinner"></span>
    </button>
    <span class="header-status-dot" id="header-status-dot" title="Click for details"></span>
    <label class="toggle-switch" title="Toggle White/Black">
      <input type="checkbox" id="side-switch">
      <span class="toggle-slider"></span>
    </label>
    <kbd class="header-shortcut" title="Middle-click to capture" style="line-height: 1.1; text-align: center;">Mouse<br>Wheel</kbd>
    <button class="settings-btn" id="settings-toggle" title="Settings">&#9881;&#65039;</button>
    <button class="close-btn" id="close-btn" title="Close Window">&#10005;</button>
  </div>

  <!-- STATUS POPOVER -->
  <div class="status-popover" id="status-popover" style="display: none;">
    <div class="popover-status">
      <span class="status-dot" id="status-dot"></span>
      <span class="status-text" id="status-text">Ready - click capture to analyze a position</span>
    </div>
    <div class="popover-thumbnail" id="popover-thumbnail" style="display: none;">
      <div class="thumbnail-container">
        <img id="thumbnail-img" src="" alt="Captured screenshot">
      </div>
    </div>
    <div class="popover-position" id="popover-position" style="display: none;">
      <div class="section-title">Position</div>
      <div class="fen-display" id="fen-display">-</div>
    </div>
  </div>

  <!-- SESSION TRACKER -->
  <div class="session-tracker" id="session-tracker" style="display: none;">
    <div class="tracker-content">
      <div class="tracker-stats">
        <span class="tracker-label">Session</span>
        <span class="tracker-accuracy" id="tracker-accuracy">0%</span>
        <span class="tracker-detail" id="tracker-detail">0/0</span>
      </div>
      <div class="tracker-bar-wrapper">
        <div class="tracker-bar" id="tracker-bar" style="width: 0%;"></div>
        <div class="tracker-threshold" id="tracker-threshold" style="left: 65%;"></div>
      </div>
    </div>
    <button class="tracker-reset" id="tracker-reset" title="Reset session">&#8634;</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="main-content">
    <!-- Best Move -->
    <div id="moves-section" style="display: none;">
      <div class="moves-list" id="moves-list">
        <div class="placeholder">Capture a position to see analysis</div>
      </div>
    </div>

    <!-- Chess Board Visualization -->
    <div class="section" id="board-section" style="display: none;">
      <div class="section-title">Board Position</div>
      <div class="chess-board-container">
        <div class="board-wrapper">
          <div class="board-ranks" id="board-ranks">
            <span>8</span><span>7</span><span>6</span><span>5</span><span>4</span><span>3</span><span>2</span><span>1</span>
          </div>
          <div class="chess-board" id="chess-board">
            <!-- 64 squares will be generated by JS -->
          </div>
        </div>
        <div class="board-labels files" id="board-files">
          <span>a</span><span>b</span><span>c</span><span>d</span><span>e</span><span>f</span><span>g</span><span>h</span>
        </div>
        <div class="move-legend">
          <div class="legend-item">
            <div class="legend-dot from"></div>
            <span>Move from</span>
          </div>
          <div class="legend-item">
            <div class="legend-dot to"></div>
            <span>Move to</span>
          </div>
        </div>
      </div>
    </div>

    <!-- API COST TRACKING -->
    <div id="cost-display" class="cost-display" style="display:none">
      <div class="cost-row">
        <span class="cost-label">This move</span>
        <span id="cost-move" class="cost-value">$0.0000</span>
      </div>
      <div class="cost-row">
        <span class="cost-label">Session</span>
        <span id="cost-session" class="cost-value">$0.0000</span>
      </div>
    </div>

  </div>

  <!-- SETTINGS PANEL -->
  <div class="settings-panel" id="settings-panel">
    <button class="back-btn" id="back-btn">&#8592; Back to Analysis</button>

    <!-- ANTHROPIC PROVIDER -->
    <div class="provider-section" id="anthropic-section" data-provider="anthropic">
      <div class="provider-header">
        <label class="provider-radio-label">
          <input type="radio" name="active-provider" value="anthropic" id="anthropic-radio" class="provider-radio">
          <span class="provider-title">Anthropic (Direct)</span>
        </label>
      </div>
      <div class="provider-content">
        <div class="form-group">
          <label for="anthropic-model">Model</label>
          <select id="anthropic-model">
            <option value="claude-opus-4-5-20251101">Claude Opus 4.5 (Best Accuracy)</option>
            <option value="claude-sonnet-4-5-20250929">Claude Sonnet 4.5 (Balanced)</option>
            <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Faster/Cheaper)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="anthropic-key">API Key</label>
          <div class="api-key-wrapper">
            <input type="password" id="anthropic-key" placeholder="sk-ant-api03-...">
            <button type="button" class="toggle-key-btn" data-target="anthropic-key" title="Show/Hide API Key">
              <svg class="eye-icon eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-icon eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
          <p class="form-hint">Get your key at <a href="https://console.anthropic.com/" target="_blank" style="color: #3498db;">console.anthropic.com</a></p>
        </div>
      </div>
    </div>

    <!-- OPENROUTER PROVIDER -->
    <div class="provider-section" id="openrouter-section" data-provider="openrouter">
      <div class="provider-header">
        <label class="provider-radio-label">
          <input type="radio" name="active-provider" value="openrouter" id="openrouter-radio" class="provider-radio">
          <span class="provider-title">OpenRouter</span>
        </label>
      </div>
      <div class="provider-content">
        <div class="form-group">
          <label for="openrouter-model">Model</label>
          <select id="openrouter-model">
            <option value="google/gemini-3-pro-preview">Gemini 3 Pro Preview</option>
            <option value="google/gemini-3-flash-preview">Gemini 3 Flash Preview</option>
            <option value="anthropic/claude-opus-4.5">Claude Opus 4.5</option>
          </select>
        </div>
        <div class="form-group">
          <label for="openrouter-key">API Key</label>
          <div class="api-key-wrapper">
            <input type="password" id="openrouter-key" placeholder="sk-or-v1-...">
            <button type="button" class="toggle-key-btn" data-target="openrouter-key" title="Show/Hide API Key">
              <svg class="eye-icon eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-icon eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
          <p class="form-hint">Get your key at <a href="https://openrouter.ai/" target="_blank" style="color: #3498db;">openrouter.ai</a></p>
        </div>
      </div>
    </div>

    <!-- BIGMODEL (ZHIPU AI) PROVIDER -->
    <div class="provider-section" id="bigmodel-section" data-provider="bigmodel">
      <div class="provider-header">
        <label class="provider-radio-label">
          <input type="radio" name="active-provider" value="bigmodel" id="bigmodel-radio" class="provider-radio">
          <span class="provider-title">BigModel (Zhipu AI)</span>
        </label>
      </div>
      <div class="provider-content">
        <div class="form-group">
          <label for="bigmodel-model">Model</label>
          <select id="bigmodel-model">
            <option value="glm-4v">GLM-4V</option>
            <option value="glm-4v-plus">GLM-4V Plus</option>
          </select>
        </div>
        <div class="form-group">
          <label for="bigmodel-key">API Key</label>
          <div class="api-key-wrapper">
            <input type="password" id="bigmodel-key" placeholder="your-api-key...">
            <button type="button" class="toggle-key-btn" data-target="bigmodel-key" title="Show/Hide API Key">
              <svg class="eye-icon eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-icon eye-closed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
          <p class="form-hint">Get your key at <a href="https://bigmodel.cn/" target="_blank" style="color: #3498db;">bigmodel.cn</a></p>
        </div>
      </div>
    </div>

    <!-- PLAY STYLE (Elo Selection) -->
    <div class="section" style="margin-top: 16px;">
      <div class="section-title">Play Style</div>
      <div class="form-group">
        <label for="target-elo">Target Elo: <span id="elo-value" style="font-weight: 600; color: #3498db;">1500</span></label>
        <input type="range" id="target-elo" min="800" max="2400" step="100" value="1500"
               style="width: 100%; accent-color: #3498db; margin-top: 6px;">
        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 2px;">
          <span>800</span><span>1200</span><span>1600</span><span>2000</span><span>2400</span>
        </div>
        <p class="form-hint">Lower = more varied moves. Higher = closer to engine best.</p>
      </div>
    </div>

    <button class="save-btn" id="save-btn">&#128190; Save Settings</button>

    <div class="section" style="margin-top: 16px;">
      <div class="section-title">API Status</div>
      <div class="status-indicators">
        <div class="status-indicator" id="anthropic-indicator" title="Claude API">
          <svg class="status-svg" viewBox="0 0 12 12">
            <circle cx="6" cy="6" r="5" fill="#666"/>
          </svg>
          <span class="status-label">Claude API</span>
        </div>
        <div class="status-indicator" id="stockfish-indicator" title="Stockfish API">
          <svg class="status-svg" viewBox="0 0 12 12">
            <circle cx="6" cy="6" r="5" fill="#666"/>
          </svg>
          <span class="status-label">Stockfish</span>
        </div>
        <div class="status-indicator" id="error-indicator" title="Error Log">
          <svg class="status-svg" viewBox="0 0 12 12">
            <circle cx="6" cy="6" r="5" fill="#666"/>
          </svg>
          <span class="status-label">Errors</span>
          <span class="error-count" id="error-count" style="display: none;">0</span>
        </div>
      </div>
      <button class="check-btn" id="check-apis-btn">Check Connections</button>
      <div class="error-log" id="error-log" style="display: none;">
        <div class="error-log-header">
          <span>Error Log</span>
          <button class="clear-errors-btn" id="clear-errors-btn">Clear</button>
        </div>
        <div class="error-log-content" id="error-log-content"></div>
      </div>
    </div>

    <!-- Debug Logs Section -->
    <div class="settings-group">
      <h3>Debug Logs</h3>
      <p style="font-size: 11px; color: #888; margin-bottom: 8px;">
        View detailed API responses for troubleshooting Vision issues.
      </p>
      <div style="display: flex; gap: 8px;">
        <button class="check-btn" id="view-debug-logs-btn">View Logs</button>
        <button class="check-btn" id="download-debug-logs-btn">Download</button>
        <button class="check-btn" id="clear-debug-logs-btn" style="background: #555;">Clear</button>
      </div>
      <div class="debug-log-viewer" id="debug-log-viewer" style="display: none; margin-top: 10px;">
        <div class="debug-log-content" id="debug-log-content" style="max-height: 300px; overflow-y: auto; background: #1a1a2e; border-radius: 6px; padding: 10px; font-family: monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all;"></div>
      </div>
    </div>

    <!-- Version Footer -->
    <div class="settings-footer">
      <span class="settings-version">Chess Study Tool v3.10.4</span>
      <span class="settings-credits">Powered by Claude Vision & Lichess</span>
    </div>
  </div>

  <!-- Mermaid Library (bundled locally for CSP compliance) -->
  <script src="panel.js"></script>
</body>
</html>
